{{- if (not (.Capabilities.APIVersions.Has "apiextensions.k8s.io/v1")) }}
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: internalusercas.siptls.sec.ericsson.com
  labels:
    {{- include "eric-sec-sip-tls-crd.labels" . | nindent 4 }}
  annotations:
    {{- include "eric-sec-sip-tls-crd.annotations" . | indent 4 }}
    "helm.sh/resource-policy": keep
    meta.helm.sh/release-name: {{ .Release.Name }}
    meta.helm.sh/release-namespace: {{ .Release.Namespace }}
spec:
  group: siptls.sec.ericsson.com
  versions:
  - name: v1alpha1
    served: true
    storage: false
  - name: v1
    served: true
    storage: true
  scope: Namespaced
  names:
    plural: internalusercas
    singular: internaluserca
    kind: InternalUserCA
    shortNames:
      - intuserca
      - intusercas
  {{- if and ( ge .Capabilities.KubeVersion.Major "1" ) ( ge .Capabilities.KubeVersion.Minor "15" ) }}
  preserveUnknownFields: false
  {{- end }}
  validation:
    openAPIV3Schema:
      type: object
      description: InternalUserCA is used to request a CA certificate from SIP-TLS.
      properties:
        spec:
          required:
            - kubernetes
            - certificate
          type: object
          description: Spec defines the properties of the CA certificate.
          properties:
            kubernetes:
              type: object
              description: Defines properties related to the storage of the certificate and private key in Kubernetes.
              required:
                - generatedSecretName
              properties:
                generatedSecretName:
                  type: string
                  description: The secret where the CA certificate is stored. The same secret should not be used for
                               multiple purposes.
                  # Use the same regex as used by Kubernetes API Server
                  pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*$'
                certificateName:
                  type: string
                  description: The YAML key name of the CA certificate in the secret. If not given, 'ca.pem' is used.
                  # Disallow whitespace
                  pattern: '^[^\s]+$'
            certificate:
              type: object
              description: Defines properties related to the content of the CA certificate.
              required:
                - subject
              properties:
                subject:
                  type: object
                  description: Properties related to X.509 'Subject' field.
                  required:
                    - cn
                  properties:
                    cn:
                      type: string
                      description: The Subject Common Name (CN) of the CA certificate.
                      # Don't allow empty string
                      minLength: 1
                      maxLength: 63
  additionalPrinterColumns:
    - name: CN
      type: string
      description: The requested CA certificate common name.
      JSONPath: .spec.certificate.subject.cn
    - name: Secret
      type: string
      description: The Kubernetes secret where the CA certificate is stored.
      JSONPath: .spec.kubernetes.generatedSecretName
{{- else }}
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: internalusercas.siptls.sec.ericsson.com
  labels:
    {{- include "eric-sec-sip-tls-crd.labels" . | nindent 4 }}
  annotations:
    {{- include "eric-sec-sip-tls-crd.annotations" . | indent 4 }}
    "helm.sh/resource-policy": keep
    meta.helm.sh/release-name: {{ .Release.Name }}
    meta.helm.sh/release-namespace: {{ .Release.Namespace }}
spec:
  group: siptls.sec.ericsson.com
  versions:
  - name: v1alpha1
    served: true
    {{- if and ( ge .Capabilities.KubeVersion.Major "1" ) ( ge .Capabilities.KubeVersion.Minor "19" ) }}
    # This indicates that the v1alpha1 version of the custom resource is deprecated.
    # API requests to this version receive a warning header in the server response.
    deprecated: true
    # This overrides the default warning returned to API clients making v1alpha1 API requests.
    deprecationWarning: "siptls.sec.ericsson.com/v1alpha1 will be removed from 25-02-2022; please use apiVersion siptls.sec.ericsson.com/v1"
    {{- end }}
    storage: false
    additionalPrinterColumns:
      - name: CN
        type: string
        description: The requested CA certificate common name.
        jsonPath: .spec.certificate.subject.cn
      - name: Secret
        type: string
        description: The Kubernetes secret where the CA certificate is stored.
        jsonPath: .spec.kubernetes.generatedSecretName
    schema:
      openAPIV3Schema:
        type: object
        description: InternalUserCA is used to request a CA certificate from SIP-TLS.
        properties:
          spec:
            required:
              - kubernetes
              - certificate
            type: object
            description: Spec defines the properties of the CA certificate.
            properties:
              kubernetes:
                type: object
                description: Defines properties related to the storage of the certificate and private key in Kubernetes.
                required:
                  - generatedSecretName
                properties:
                  generatedSecretName:
                    type: string
                    description: The secret where the CA certificate is stored. The same secret should not be used for
                      multiple purposes.
                    # Use the same regex as used by Kubernetes API Server
                    pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*$'
                  certificateName:
                    type: string
                    description: The YAML key name of the CA certificate in the secret. If not given, 'ca.pem' is used.
                    # Disallow whitespace
                    pattern: '^[^\s]+$'
              certificate:
                type: object
                description: Defines properties related to the content of the CA certificate.
                required:
                  - subject
                properties:
                  subject:
                    type: object
                    description: Properties related to X.509 'Subject' field.
                    required:
                      - cn
                    properties:
                      cn:
                        type: string
                        description: The Subject Common Name (CN) of the CA certificate.
                        # Don't allow empty string
                        minLength: 1
                        maxLength: 63
  - name: v1
    served: true
    storage: true
    additionalPrinterColumns:
      - name: CN
        type: string
        description: The requested CA certificate common name.
        jsonPath: .spec.certificate.subject.cn
      - name: Secret
        type: string
        description: The Kubernetes secret where the CA certificate is stored.
        jsonPath: .spec.kubernetes.generatedSecretName
    schema:
      openAPIV3Schema:
        type: object
        description: InternalUserCA is used to request a CA certificate from SIP-TLS.
        properties:
          spec:
            required:
              - kubernetes
              - certificate
            type: object
            description: Spec defines the properties of the CA certificate.
            properties:
              kubernetes:
                type: object
                description: Defines properties related to the storage of the certificate and private key in Kubernetes.
                required:
                  - generatedSecretName
                properties:
                  generatedSecretName:
                    type: string
                    description: The secret where the CA certificate is stored. The same secret should not be used for
                      multiple purposes.
                    # Use the same regex as used by Kubernetes API Server
                    pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*$'
                  certificateName:
                    type: string
                    description: The YAML key name of the CA certificate in the secret. If not given, 'ca.pem' is used.
                    # Disallow whitespace
                    pattern: '^[^\s]+$'
              certificate:
                type: object
                description: Defines properties related to the content of the CA certificate.
                required:
                  - subject
                properties:
                  subject:
                    type: object
                    description: Properties related to X.509 'Subject' field.
                    required:
                      - cn
                    properties:
                      cn:
                        type: string
                        description: The Subject Common Name (CN) of the CA certificate.
                        # Don't allow empty string
                        minLength: 1
                        maxLength: 63
  scope: Namespaced
  names:
    plural: internalusercas
    singular: internaluserca
    kind: InternalUserCA
    shortNames:
      - intuserca
      - intusercas
  preserveUnknownFields: false
{{- end }}