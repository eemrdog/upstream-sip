# Service account token that enable fetching credentials from vault
# Used for example reconfiguration of Vault during upgrade
# Resource is created after installation, pod restart case
# before upgrade, upgrade from release not having the secret
# after upgrade, mitigate upg-install case
# Resource is always deleted before it is created
# DEPRECATED - will be removed

apiVersion: v1
kind: Secret
metadata:
  name: {{ template "eric-sec-key-management.name" . }}-admin-token
  labels:
    {{- include "eric-sec-key-management.labels" . | nindent 4 }}
  annotations:
    {{- $svcAcc := dict -}}
    {{- $_ := set $svcAcc "kubernetes.io/service-account.name" (printf "%s-admin" (include "eric-sec-key-management.name" .)) -}}
    {{- $helmHooks := dict -}}
    {{- $_ := set $helmHooks "helm.sh/hook" "post-install,pre-upgrade,post-upgrade" -}}
    {{- $_ := set $helmHooks "helm.sh/hook-delete-policy" "before-hook-creation" -}}
    {{- $commonAnn := include "eric-sec-key-management.annotations" . | fromYaml -}}
    {{- include "eric-sec-key-management.mergeAnnotations" (dict "location" .Template.Name "sources" (list $svcAcc $helmHooks $commonAnn)) | trim | nindent 4 }}
type: kubernetes.io/service-account-token
