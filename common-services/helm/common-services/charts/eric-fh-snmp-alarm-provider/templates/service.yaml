{{ if or ( eq (include "eric-fh-snmp-alarm-provider.enabled-IPv4" .) "true" ) (eq (include "eric-fh-snmp-alarm-provider.enabled-IPv6" .) "true" ) }}
{{- if eq (include "eric-fh-snmp-alarm-provider.enabled-IPv4" .) "true" -}}
apiVersion: v1
kind: Service
metadata:
  name: {{ template "eric-fh-snmp-alarm-provider.name" . }}-ipv4
  labels:
{{- include "eric-fh-snmp-alarm-provider.helm-labels" . | indent 4 }}
    app: {{ template "eric-fh-snmp-alarm-provider.name" . }}
    chart: {{ template "eric-fh-snmp-alarm-provider.chart" . }}
    heritage: {{ .Release.Service | quote }}
    release: {{ .Release.Name | quote }}
  annotations:
{{- include "eric-fh-snmp-alarm-provider.annotations" . | indent 4 }}
{{- if .Values.service.externalIPv4.annotations }}
{{- if .Values.service.externalIPv4.cloudProviderLB}}
{{ toYaml .Values.service.externalIPv4.cloudProviderLB | indent 4 }}
{{- end }}
{{- if .Values.service.externalIPv4.annotations.sharedVIPLabel }}
    metallb.universe.tf/allow-shared-ip: {{.Values.service.externalIPv4.annotations.sharedVIPLabel }}
{{- end -}}
{{- if .Values.service.externalIPv4.annotations.addressPoolName }}
    metallb.universe.tf/address-pool: {{ .Values.service.externalIPv4.annotations.addressPoolName }}
{{- end -}}
{{- end }}
spec:
  ipFamilies: ["IPv4"]   # ipFamilies was introduced in K8s v1.20
  type: {{ .Values.service.type }}
{{- if .Values.service.clusterIP }}
  clusterIP: {{ .Values.service.clusterIP | quote }}
{{- end }}
{{- if .Values.service.externalIPs }}
  externalIPs:
{{ toYaml .Values.service.externalIPs | indent 4 }}
{{- end }}
{{- if .Values.service.externalIPv4.loadBalancerIP }}
  loadBalancerIP: {{ .Values.service.externalIPv4.loadBalancerIP }}
{{- end }}
{{- if .Values.service.externalIPv4.loadBalancerSourceRanges }}
  loadBalancerSourceRanges:
{{ toYaml .Values.service.externalIPv4.loadBalancerSourceRanges | indent 4 }}
{{- end }}
  ports:
    - protocol: UDP
      name: udp
      port: {{ .Values.service.externalIPv4.servicePort }}
      targetPort: {{ .Values.service.snmpAgentPort }}
{{- if .Values.service.nodePort }}
      nodePort: {{ .Values.service.nodePort }}
{{- end }}
  selector:
    app: {{ template "eric-fh-snmp-alarm-provider.name" . }}
    release: {{ .Release.Name | quote }}

{{- end }}
---
{{ if eq (include "eric-fh-snmp-alarm-provider.enabled-IPv6" .) "true" -}}
apiVersion: v1
kind: Service
metadata:
  name: {{ template "eric-fh-snmp-alarm-provider.name" . }}-ipv6
  labels:
{{- include "eric-fh-snmp-alarm-provider.helm-labels" . | indent 4 }}
    app: {{ template "eric-fh-snmp-alarm-provider.name" . }}
    chart: {{ template "eric-fh-snmp-alarm-provider.chart" . }}
    heritage: {{ .Release.Service | quote }}
    release: {{ .Release.Name | quote }}
  annotations:
{{- include "eric-fh-snmp-alarm-provider.annotations" . | indent 4 }}
{{- if .Values.service.externalIPv6.annotations }}
{{- if .Values.service.externalIPv6.cloudProviderLB}}
{{ toYaml .Values.service.externalIPv6.cloudProviderLB | indent 4 }}
{{- end }}
{{- if .Values.service.externalIPv6.annotations.sharedVIPLabel }}
    metallb.universe.tf/allow-shared-ip: {{.Values.service.externalIPv6.annotations.sharedVIPLabel }}
{{- end -}}
{{- if .Values.service.externalIPv6.annotations.addressPoolName }}
    metallb.universe.tf/address-pool: {{ .Values.service.externalIPv6.annotations.addressPoolName }}
{{- end -}}
{{- end }}
spec:
  ipFamilies: ["IPv6"]   # ipFamilies was introduced in K8s v1.20
  type: {{ .Values.service.type }}
{{- if .Values.service.clusterIP }}
  clusterIP: {{ .Values.service.clusterIP | quote }}
{{- end }}
{{- if .Values.service.externalIPs }}
  externalIPs:
{{ toYaml .Values.service.externalIPs | indent 4 }}
{{- end }}
{{- if .Values.service.externalIPv6.loadBalancerIP }}
  loadBalancerIP: {{ .Values.service.externalIPv6.loadBalancerIP }}
{{- end }}
{{- if .Values.service.externalIPv6.loadBalancerSourceRanges }}
  loadBalancerSourceRanges:
{{ toYaml .Values.service.externalIPv6.loadBalancerSourceRanges | indent 4 }}
{{- end }}
  ports:
    - protocol: UDP
      name: udp
      port: {{ .Values.service.externalIPv6.servicePort }}
      targetPort: {{ .Values.service.snmpAgentPort }}
{{- if .Values.service.nodePort }}
      nodePort: {{ .Values.service.nodePort }}
{{- end }}
  selector:
    app: {{ template "eric-fh-snmp-alarm-provider.name" . }}
    release: {{ .Release.Name | quote }}
{{- end }}
{{ else }}
apiVersion: v1
kind: Service
metadata:
  name: {{ template "eric-fh-snmp-alarm-provider.name" . }}
  labels:
{{- include "eric-fh-snmp-alarm-provider.helm-labels" . | indent 4 }}
    app: {{ template "eric-fh-snmp-alarm-provider.name" . }}
    chart: {{ template "eric-fh-snmp-alarm-provider.chart" . }}
    heritage: {{ .Release.Service | quote }}
    release: {{ .Release.Name | quote }}
  annotations:
{{- include "eric-fh-snmp-alarm-provider.annotations" . | indent 4 }}
{{- if .Values.service.annotations }}
{{- if .Values.service.annotations.cloudProviderLB}}
{{ toYaml .Values.service.annotations.cloudProviderLB | indent 4 }}
{{- end }}
{{- if .Values.service.annotations.sharedVIPLabel }}
    metallb.universe.tf/allow-shared-ip: {{.Values.service.annotations.sharedVIPLabel }}
{{- end -}}
{{- if .Values.service.annotations.addressPoolName }}
    metallb.universe.tf/address-pool: {{ .Values.service.annotations.addressPoolName }}
{{- end -}}
{{- end }}
spec:
  type: {{ .Values.service.type }}
{{- if .Values.service.clusterIP }}
  clusterIP: {{ .Values.service.clusterIP | quote }}
{{- end }}
{{- if .Values.service.externalIPs }}
  externalIPs:
{{ toYaml .Values.service.externalIPs | indent 4 }}
{{- end }}
{{- if .Values.service.loadBalancerIP }}
  loadBalancerIP: {{ .Values.service.loadBalancerIP | quote }}
{{- end }}
{{- if .Values.service.loadBalancerSourceRanges }}
  loadBalancerSourceRanges:
{{ toYaml .Values.service.loadBalancerSourceRanges | indent 4 }}
{{- end }}
  ports:
    - protocol: UDP
      name: udp
      port: {{ .Values.service.servicePort }}
      targetPort: {{ .Values.service.snmpAgentPort }}
{{- if .Values.service.nodePort }}
      nodePort: {{ .Values.service.nodePort }}
{{- end }}
  selector:
    app: {{ template "eric-fh-snmp-alarm-provider.name" . }}
    release: {{ .Release.Name | quote }}
{{- end }}
