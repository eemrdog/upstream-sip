{{ if or ( eq (include "eric-fh-snmp-alarm-provider.enabled-IPv4" .) "true" ) (eq (include "eric-fh-snmp-alarm-provider.enabled-IPv6" .) "true" ) }}
{{- if eq (include "eric-fh-snmp-alarm-provider.enabled-IPv4" .) "true" -}}
apiVersion: v1
kind: Service
metadata:
  name: {{ template "eric-fh-snmp-alarm-provider.name" . }}-ipv4
  labels:
    {{- $staticLabels := dict -}}
    {{- $_ := set $staticLabels "app" (include "eric-fh-snmp-alarm-provider.name" .) -}}
    {{- $_ := set $staticLabels "chart" (include "eric-fh-snmp-alarm-provider.chart" .) -}}
    {{- $_ := set $staticLabels "heritage" (.Release.Service | toString) -}}
    {{- $_ := set $staticLabels "release" (.Release.Name | toString) -}}
    {{- $defaultLabels := include "eric-fh-snmp-alarm-provider.labels" . | fromYaml -}}
    {{- include "eric-fh-snmp-alarm-provider.mergeLabels" (dict "location" (.Template.Name) "sources" (list $staticLabels $defaultLabels)) | trim | nindent 4 }}
  annotations:
    {{- $staticAnn := dict -}}
    {{- $cloudProviderAnn := dict -}}
    {{- if .Values.service.externalIPv4.annotations }}
      {{- if .Values.service.externalIPv4.annotations.cloudProviderLB }}
        {{- range $key, $value := .Values.service.externalIPv4.cloudProviderLB -}}
          {{- $_ := set $cloudProviderAnn $key $value -}}
        {{- end -}}
      {{- end -}}
      {{- if .Values.service.externalIPv4.annotations.sharedVIPLabel }}
        {{- $_ := set $staticAnn "metallb.universe.tf/allow-shared-ip" (.Values.service.externalIPv4.annotations.sharedVIPLabel | toString) -}}
      {{- end -}}
      {{- if .Values.service.externalIPv4.annotations.addressPoolName }}
        {{- $_ := set $staticAnn "metallb.universe.tf/address-pool" (.Values.service.externalIPv4.annotations.addressPoolName | toString) -}}
      {{- end -}}
    {{- end -}}
    {{- $defaultAnn := include "eric-fh-snmp-alarm-provider.annotations" . | fromYaml -}}
    {{- include "eric-fh-snmp-alarm-provider.mergeAnnotations" (dict "location" (.Template.Name) "sources" (list $staticAnn $cloudProviderAnn $defaultAnn)) | trim | nindent 4 }}
spec:
  ipFamilies: ["IPv4"]   # ipFamilies was introduced in K8s v1.20
  type: {{ .Values.service.type }}
{{- if .Values.service.clusterIP }}
  clusterIP: {{ .Values.service.clusterIP | quote }}
{{- end }}
{{- if .Values.service.externalIPs }}
  externalIPs:
{{ toYaml .Values.service.externalIPs | indent 4 }}
{{- end }}
{{- if .Values.service.externalIPv4.loadBalancerIP }}
  loadBalancerIP: {{ .Values.service.externalIPv4.loadBalancerIP }}
{{- end }}
{{- if .Values.service.externalIPv4.loadBalancerSourceRanges }}
  loadBalancerSourceRanges:
{{ toYaml .Values.service.externalIPv4.loadBalancerSourceRanges | indent 4 }}
{{- end }}
  ports:
    - protocol: UDP
      name: udp
      port: {{ .Values.service.externalIPv4.servicePort }}
      targetPort: {{ .Values.service.snmpAgentPort }}
{{- if .Values.service.nodePort }}
      nodePort: {{ .Values.service.nodePort }}
{{- end }}
  selector:
    app: {{ template "eric-fh-snmp-alarm-provider.name" . }}
    release: {{ .Release.Name | quote }}

{{- end }}
---
{{ if eq (include "eric-fh-snmp-alarm-provider.enabled-IPv6" .) "true" -}}
apiVersion: v1
kind: Service
metadata:
  name: {{ template "eric-fh-snmp-alarm-provider.name" . }}-ipv6
  labels:
    {{- $staticLabels := dict -}}
    {{- $_ := set $staticLabels "app" (include "eric-fh-snmp-alarm-provider.name" .) -}}
    {{- $_ := set $staticLabels "chart" (include "eric-fh-snmp-alarm-provider.chart" .) -}}
    {{- $_ := set $staticLabels "heritage" (.Release.Service | toString) -}}
    {{- $_ := set $staticLabels "release" (.Release.Name | toString) -}}
    {{- $defaultLabels := include "eric-fh-snmp-alarm-provider.labels" . | fromYaml -}}
    {{- include "eric-fh-snmp-alarm-provider.mergeLabels" (dict "location" (.Template.Name) "sources" (list $staticLabels $defaultLabels)) | trim | nindent 4 }}
  annotations:
    {{- $staticAnn := dict -}}
    {{- $cloudProviderAnn := dict -}}
    {{- if .Values.service.externalIPv6.annotations }}
      {{- if .Values.service.externalIPv6.annotations.cloudProviderLB }}
      {{- range $key, $value := .Values.service.externalIPv6.cloudProviderLB -}}
          {{- $_ := set $cloudProviderAnn $key $value -}}
        {{- end -}}
      {{- end -}}
      {{- if .Values.service.externalIPv6.annotations.sharedVIPLabel }}
        {{- $_ := set $staticAnn "metallb.universe.tf/allow-shared-ip" (.Values.service.externalIPv6.annotations.sharedVIPLabel | toString) -}}
      {{- end -}}
      {{- if .Values.service.externalIPv6.annotations.addressPoolName }}
        {{- $_ := set $staticAnn "metallb.universe.tf/address-pool" (.Values.service.externalIPv6.annotations.addressPoolName | toString) -}}
      {{- end -}}
    {{- end -}}
    {{- $defaultAnn := include "eric-fh-snmp-alarm-provider.annotations" . | fromYaml -}}
    {{- include "eric-fh-snmp-alarm-provider.mergeAnnotations" (dict "location" (.Template.Name) "sources" (list $staticAnn $cloudProviderAnn $defaultAnn)) | trim | nindent 4 }}
spec:
  ipFamilies: ["IPv6"]   # ipFamilies was introduced in K8s v1.20
  type: {{ .Values.service.type }}
{{- if .Values.service.clusterIP }}
  clusterIP: {{ .Values.service.clusterIP | quote }}
{{- end }}
{{- if .Values.service.externalIPs }}
  externalIPs:
{{ toYaml .Values.service.externalIPs | indent 4 }}
{{- end }}
{{- if .Values.service.externalIPv6.loadBalancerIP }}
  loadBalancerIP: {{ .Values.service.externalIPv6.loadBalancerIP }}
{{- end }}
{{- if .Values.service.externalIPv6.loadBalancerSourceRanges }}
  loadBalancerSourceRanges:
{{ toYaml .Values.service.externalIPv6.loadBalancerSourceRanges | indent 4 }}
{{- end }}
  ports:
    - protocol: UDP
      name: udp
      port: {{ .Values.service.externalIPv6.servicePort }}
      targetPort: {{ .Values.service.snmpAgentPort }}
{{- if .Values.service.nodePort }}
      nodePort: {{ .Values.service.nodePort }}
{{- end }}
  selector:
    app: {{ template "eric-fh-snmp-alarm-provider.name" . }}
    release: {{ .Release.Name | quote }}
{{- end }}
{{ else }}
apiVersion: v1
kind: Service
metadata:
  name: {{ template "eric-fh-snmp-alarm-provider.name" . }}
  labels:
    {{- $staticLabels := dict -}}
    {{- $_ := set $staticLabels "app" (include "eric-fh-snmp-alarm-provider.name" .) -}}
    {{- $_ := set $staticLabels "chart" (include "eric-fh-snmp-alarm-provider.chart" .) -}}
    {{- $_ := set $staticLabels "heritage" (.Release.Service | toString) -}}
    {{- $_ := set $staticLabels "release" (.Release.Name | toString) -}}
    {{- $defaultLabels := include "eric-fh-snmp-alarm-provider.labels" . | fromYaml -}}
    {{- include "eric-fh-snmp-alarm-provider.mergeLabels" (dict "location" (.Template.Name) "sources" (list $staticLabels $defaultLabels)) | trim | nindent 4 }}
  annotations:
    {{- $staticAnn := dict -}}
    {{- $cloudProviderAnn := dict -}}
    {{- if .Values.service.annotations }}
      {{- if .Values.service.annotations.cloudProviderLB}}
        {{- range $key, $value := .Values.service.annotations.cloudProviderLB -}}
          {{- $_ := set $cloudProviderAnn $key $value -}}
        {{- end -}}
      {{- end -}}
      {{- if .Values.service.annotations.sharedVIPLabel}}
        {{- $_ := set $staticAnn "metallb.universe.tf/allow-shared-ip" (.Values.service.annotations.sharedVIPLabel | toString) -}}
      {{- end -}}
      {{- if .Values.service.annotations.addressPoolName}}
        {{- $_ := set $staticAnn "metallb.universe.tf/address-pool" (.Values.service.annotations.addressPoolName | toString) -}}
      {{- end -}}
    {{- end -}}
    {{- $defaultAnn := include "eric-fh-snmp-alarm-provider.annotations" . | fromYaml -}}
    {{- include "eric-fh-snmp-alarm-provider.mergeAnnotations" (dict "location" (.Template.Name) "sources" (list $staticAnn $cloudProviderAnn $defaultAnn)) | trim | nindent 4 }}
spec:
  type: {{ .Values.service.type }}
{{- if .Values.service.clusterIP }}
  clusterIP: {{ .Values.service.clusterIP | quote }}
{{- end }}
{{- if .Values.service.externalIPs }}
  externalIPs:
{{ toYaml .Values.service.externalIPs | indent 4 }}
{{- end }}
{{- if .Values.service.loadBalancerIP }}
  loadBalancerIP: {{ .Values.service.loadBalancerIP | quote }}
{{- end }}
{{- if .Values.service.loadBalancerSourceRanges }}
  loadBalancerSourceRanges:
{{ toYaml .Values.service.loadBalancerSourceRanges | indent 4 }}
{{- end }}
  ports:
    - protocol: UDP
      name: udp
      port: {{ .Values.service.servicePort }}
      targetPort: {{ .Values.service.snmpAgentPort }}
{{- if .Values.service.nodePort }}
      nodePort: {{ .Values.service.nodePort }}
{{- end }}
  selector:
    app: {{ template "eric-fh-snmp-alarm-provider.name" . }}
    release: {{ .Release.Name | quote }}
{{- end }}
