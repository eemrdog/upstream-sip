{{- $g := fromJson (include "eric-data-search-engine.global" .) -}}
{{- $name := print (include "eric-data-search-engine.fullname.host" .) -}}
{{- $service := (lookup "v1" "Service" .Release.Namespace $name) -}}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "eric-data-search-engine.fullname" . }}-preupgrade-rollback-hook
  annotations:
    "helm.sh/hook": "pre-upgrade,pre-rollback"
    "helm.sh/hook-delete-policy": hook-succeeded
  {{- include "eric-data-search-engine.annotations" . | indent 4 }}
spec:
  template:
    metadata:
      labels:
        {{- include "eric-data-search-engine.labels" . | indent 8 }}
        app: {{ include "eric-data-search-engine.fullname" . | quote }}
        component: eric-data-search-engine
    spec:
    {{- if .Capabilities.APIVersions.Has "v1/ServiceAccount" }}
      serviceAccount: ""
    {{- end }}
      serviceAccountName: {{ include "eric-data-search-engine.fullname" . }}-sa
    {{- if .Values.tolerations.preupgradehook }}
      tolerations: {{- toYaml .Values.tolerations.preupgradehook | nindent 6 }}
    {{- end }}
      restartPolicy: OnFailure
      {{- include "eric-data-search-engine.pullSecrets" . | indent 6 }}
      containers:
        - name: pre-upgrade-rollback-container
          image: {{ include "eric-data-search-engine.image-registry-url" . | quote }}
          imagePullPolicy: {{ .Values.imageCredentials.registry.imagePullPolicy | default $g.registry.imagePullPolicy | quote }}
          env:
          - name: TZ
            value: {{ $g.timezone | quote }}
          - name: "ES_REST_TLS"
          {{- if and $g.security.tls.enabled }}
            value: "true"
          {{- else }}
            value: "false"
          {{- end }}
          - name: ELASTICSEARCH_HOST
            value: {{ include "eric-data-search-engine-elasticsearch-host" . | quote }}
          - name: SERVICE_AVAILABILITY
          {{- if $service }}
            value: "YES"
          {{- else }}
            value: "NO"
          {{- end }}
          - name: DELAYED_TIMEOUT
            value: {{ .Values.unassignedNode_leftDelayed_timeout | default "3m" | quote }}
          args:
            - /pre-upgrade-rollback.sh
          securityContext:
            allowPrivilegeEscalation: false
            privileged: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            capabilities:
              drop:
                - "all"
          volumeMounts:
          {{- if and ($service) ($g.security.tls.enabled)}}
            {{- include "eric-data-search-engine.security-tls-secret-volume-mounts-http-client" . | indent 12 }}
          {{- end }}
          resources: {{- include "eric-data-search-engine.resources" .Values.resources.preupgradehook | nindent 12 }}
      volumes:
      {{- if and ($service) ($g.security.tls.enabled)}}
        {{- include "eric-data-search-engine.security-tls-secret-volumes-http-client" . | indent 8 }}
      {{- end }}
