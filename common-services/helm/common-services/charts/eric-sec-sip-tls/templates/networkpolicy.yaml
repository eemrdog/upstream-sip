{{- $globals := fromJson (include "eric-sec-sip-tls.global" .) -}}
{{- if and $globals.networkPolicy .Values.networkPolicy -}}
{{- if and $globals.networkPolicy.enabled .Values.networkPolicy.enabled -}}
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ template "eric-sec-sip-tls.name" . }}-pm-allow
  labels:
    {{- include "eric-sec-sip-tls.labels" . | nindent 4 }}
  annotations:
    {{- include "eric-sec-sip-tls.annotations" . | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: {{ template "eric-sec-sip-tls.name" . }}
  policyTypes:
  - Ingress
  ingress:
    # Allow inbound connections
{{- if eq (include "eric-sec-sip-tls.metrics.server.enabled" .) "true" }}
    - from:
      - podSelector:
          matchLabels:
            app.kubernetes.io/name: {{ .Values.pm.serviceName }}
      ports:
      - port: {{ template "eric-sec-sip-tls.metrics.server.port" . }}
        protocol: TCP
{{- else }}
    - {}
{{- end }}
{{- end }}
{{- end }}
