{{- if and .Values.authenticationProxy.enabled .Values.authenticationProxy.ingress.enabled -}}
{{- $global := fromJson (include "eric-sec-access-mgmt.global" .) -}}
{{- if and $global.security.tls.enabled (not .Values.authenticationProxy.ingress.existingTlsSecret) -}}
apiVersion: com.ericsson.sec.certm/v1alpha2
kind: ExternalCertificate
metadata:
  name: {{ template "eric-sec-access-mgmt.name" . }}-authn-ingress-external-client-certificate
  annotations:
    {{- $secretAnnotations := (.Values.authenticationProxy.ingress.secretAnnotations) -}}
    {{- $common := include "eric-sec-access-mgmt.common-annotations" . | fromYaml -}}
    {{- include "eric-sec-access-mgmt.mergeAnnotations" (dict "location" (.Template.Name) "sources" (list $common $secretAnnotations)) | trim | nindent 4 }}
  labels: {{- include "eric-sec-access-mgmt.labels" . | nindent 4 }}
spec:
  generated-secret-name: {{ template "eric-sec-access-mgmt.name" . }}-authn-ingress-external-tls-secret
  generated-secret-type: tls
  asymmetric-key-certificate-name: {{ .Values.authenticationProxy.ingress.certificates.asymmetricKeyCertificateName | quote }}
{{- end -}}
{{ end }}
