{{- $global := fromJson (include "eric-sec-access-mgmt.global" .) -}}
{{- if and .Values.ingress.enabled (or ($global.security.tls.enabled) (eq .Values.ingress.type "iccr")) -}}
apiVersion: projectcontour.io/v1
kind: HTTPProxy
metadata:
  name: {{ template "eric-sec-access-mgmt.name" . }}
  annotations: {{- include "eric-sec-access-mgmt.common-annotations" . | nindent 4 }}
  {{- if .Values.ingress.ingressClass }}
    kubernetes.io/ingress.class: {{.Values.ingress.ingressClass | quote }}
  {{- end }}
  {{- if .Values.ingress.annotations }}
    {{- toYaml .Values.ingress.annotations | nindent 4 }}
  {{- end }}
  labels:
    {{- include "eric-sec-access-mgmt.labels" . | indent 4 }}
spec:
  virtualhost:
    fqdn: {{ .Values.ingress.hostname | quote }}
    {{- if or (eq (include "eric-sec-access-mgmt.ingressTlsEnabled" .) "true") (eq (include "eric-sec-access-mgmt.ingressTlsEnabled" .) "optional") }}
    tls:
      secretName: {{ template "eric-sec-access-mgmt.ingressTLSSecret" . }}
    {{- end }}
  routes:
    - conditions:
      - prefix: {{ .Values.ingress.path | quote }}
      {{- if eq (include "eric-sec-access-mgmt.ingressTlsEnabled" .)  "optional" }}
      permitInsecure: true
      {{- end }}
      services:
        - name: {{ template "eric-sec-access-mgmt.name" $ }}-http
          {{- if $global.security.tls.enabled }}
          protocol: tls
          port: {{ template "eric-sec-access-mgmt.serviceHttpsPort" . }}
          validation:
            caSecret: {{ .Values.tls.client.rootCaSecret }}
            subjectName: {{ template "eric-sec-access-mgmt.name" . }}
          {{- else }}
          port: {{ template "eric-sec-access-mgmt.serviceHttpPort" . }}
          {{- end }}
{{- end -}}{{- /* if ingress is enabled */}}
