{{- $service := .Values.service -}}
{{- $global := fromJson (include "eric-sec-access-mgmt.global" .) -}}
apiVersion: v1
kind: Service
metadata:
  name: {{ template "eric-sec-access-mgmt.name" . }}-http
  annotations:
    {{- $annotations := dict -}}
    {{/* the below annotation must be added for ICCR to work */}}
    {{- if and $global.security.tls.enabled .Values.ingress.enabled}}
      {{- $_ := set $annotations "contour.heptio.com/upstream-protocol.tls" (printf "http, %s" (include "eric-sec-access-mgmt.serviceHttpsPort" .)) -}}
    {{- end }}
    {{- $serviceAnnotations := ($service.annotations) -}}
    {{- $common := include "eric-sec-access-mgmt.common-annotations" . | fromYaml -}}
    {{- include "eric-sec-access-mgmt.mergeAnnotations" (dict "location" (.Template.Name) "sources" (list $serviceAnnotations $annotations $common)) | trim | nindent 4 }}
  labels:
    {{- $serviceLabels := ($service.labels) -}}
    {{- $defaultLabels := include "eric-sec-access-mgmt.labels" . | fromYaml -}}
    {{- include "eric-sec-access-mgmt.mergeLabels" (dict "location" (.Template.Name) "sources" (list $serviceLabels $defaultLabels)) | trim | nindent 4 }}

#TODO: should we use service.spec.sessionAffinity to “ClientIP” as recommended by Keycloak documentation: Sticky Sessions
spec:
  type: ClusterIP
  ports:
    {{- if $global.security.tls.enabled }}
    - name: https-tls
      port: {{ template "eric-sec-access-mgmt.serviceHttpsPort" . }}
      protocol: TCP
      targetPort: https-tls
    - name: https-admin
      port: {{ template "eric-sec-access-mgmt.serviceAdminConsolePort" . }}
      protocol: TCP
      targetPort: https-admin
    {{- end }}
    {{- if or (eq .Values.service.endpoints.iam.tls.enforced "optional") (not $global.security.tls.enabled) }}
    - name: http
      port: {{ template "eric-sec-access-mgmt.serviceHttpPort" . }}
      protocol: TCP
      targetPort: http
    - name: http-admin
      port: {{ template "eric-sec-access-mgmt.adminPortHttp" . }}
      protocol: TCP
      targetPort: http-admin
    {{- end }}
  selector:
    app: {{ template "eric-sec-access-mgmt.name" . }}
    release: {{ .Release.Name | quote }}
  {{- if $global.internalIPFamily }}
  ipFamilies: [{{ $global.internalIPFamily | quote }}]
  {{- end }}
