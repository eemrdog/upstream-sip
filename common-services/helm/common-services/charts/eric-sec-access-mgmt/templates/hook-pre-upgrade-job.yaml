apiVersion: batch/v1
kind: Job
metadata:
  name: {{ template "eric-sec-access-mgmt.name" . }}-pre-upgrade-job
  labels: {{- include "eric-sec-access-mgmt.labels" . | nindent 4 }}
  annotations: {{- include "eric-sec-access-mgmt.common-annotations" . | nindent 4 }}
    "helm.sh/hook": "pre-upgrade"
    "helm.sh/hook-delete-policy": "hook-succeeded,before-hook-creation"
    "helm.sh/hook-weight": "5"
spec:
  template:
    metadata:
      labels: {{- include "eric-sec-access-mgmt.labels" . | nindent 8 }}
        app: {{ template "eric-sec-access-mgmt.name" . }}-pre-upgrade-job
      annotations: {{- include "eric-sec-access-mgmt.common-annotations" . | nindent 8 }}
    spec:
      serviceAccountName: {{ template "eric-sec-access-mgmt.name" . }}-sa
      restartPolicy: Never
      containers:
      - name: "preupgrade"
        securityContext: {{- include "eric-sec-iam-server.containerSecurityContext" . | nindent 10 }}
        resources: {{ include "eric-sec-access-mgmt.resourcesHelper" (dict "Values" .Values "resourceName" "preupgrade") | nindent 10 }}
        image: {{ include "eric-sec-access-mgmt.imagePath" (dict "root" . "image" "iaminit") }}
        imagePullPolicy: {{ template "eric-sec-access-mgmt.imagePullPolicy" . }}
        command: ['python3', '/opt/iam/bin/hooks/pre_upgrade.py']
        env:
        - name: IAM_STATEFULSET_NAME
          value: "{{ template "eric-sec-access-mgmt.name" . }}"
        - name: IAM_VERSION
          value: "{{ template "eric-sec-access-mgmt.version" . }}"
        - name: IAM_NAMESPACE
          value: {{ .Release.Namespace | quote }}
      {{- if (include "eric-sec-access-mgmt.pullSecret" .) }}
      imagePullSecrets:
        - name: {{ template "eric-sec-access-mgmt.pullSecret" . }}
      {{- end }}
      tolerations: {{- include "eric-sec-access-mgmt.tolerations.preupgrade" . | nindent 8 }}
