apiVersion: v1
kind: Service
metadata:
  name: {{ include "eric-lm-combined-server.name" . }}
  labels:
    {{- include "eric-lm-combined-server.lch-labels" . | nindent 4 }}
  annotations:
    {{- include "eric-lm-combined-server.annotations" . | nindent 4 }}
spec:
  type: {{ .Values.licenseConsumerHandler.service.type }}
{{- if .Values.global }}
    {{- if .Values.global.internalIPFamily }}
  ipFamilies: [{{ .Values.global.internalIPFamily | quote }}]
    {{- end }}
{{- end }}
  ports:
    {{- if or (eq (include "eric-lm-combined-server.tls.enabled" .) "false") (eq .Values.licenseConsumerHandler.service.endpoints.externalHttps.tls.enforced "optional") }}
    - port: {{ include "eric-lm-combined-server.lch-insecureExternalAPIPort" . }}
      targetPort: external-http
      protocol: TCP
      name: external-http
    {{- end }}
    {{- if eq (include "eric-lm-combined-server.tls.enabled" .) "true" }}
    - port: {{ .Values.tls.lch.externalAPIPort }}
      targetPort: external-https
      protocol: TCP
      name: external-https
    {{- end }}
    {{- if eq (print .Values.ingress.enabled) "true" }}
    - port: {{ .Values.tls.lch.ingressAPIPort }}
      targetPort: ingress-https
      protocol: TCP
      name: ingress-https
    {{- end }}
  selector:
    {{- include "eric-lm-combined-server.lch-selector-labels" . | nindent 4 }}
