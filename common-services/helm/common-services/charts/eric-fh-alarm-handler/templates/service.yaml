{{- $g := fromJson (include "eric-fh-alarm-handler.global" .) }}
apiVersion: v1
kind: Service
metadata:
  name: {{ template "eric-fh-alarm-handler.name" . }}
  annotations:
{{- include "eric-fh-alarm-handler.annotations" . | indent 4 }}
  labels:
{{- include "eric-fh-alarm-handler.labels" . | indent 4 }}
spec:
  {{- if $g.internalIPFamily }}
  ipFamilies: [{{ $g.internalIPFamily | quote }}]
  {{- end }}
  type: ClusterIP
  ports:
  {{/* DR-D1123-113 */}}
  {{- if not $g.security.tls.enabled }}
    # Only cleartext due to global tls disabled
    - name: api-http
      port: {{ include "eric-fh-alarm-handler.restapi.server.port" . }}
      targetPort: http-rest-api
    {{- if eq (include "eric-fh-alarm-handler.fiAPI.httpEnabled" .) "true" }}
    - name: fi-api-http
      port: {{ include "eric-fh-alarm-handler.rest.fi.server.httpPort" . }}
      targetPort: http-fi-api
    {{- end }}
  {{- else -}}
    {{- if eq (include "eric-fh-alarm-handler.fiAPI.httpEnabled" .) "true" }}
    - name: fi-api-http
      port: {{ include "eric-fh-alarm-handler.rest.fi.server.httpPort" . }}
      targetPort: http-fi-api
    {{- end }}
    {{- if eq (include "eric-fh-alarm-handler.fiAPI.httpsEnabled" .) "true" }}
    - name: fi-api-https
      port: {{ include "eric-fh-alarm-handler.rest.fi.server.httpsPort" . }}
      targetPort: https-fi-api
    {{- end }}
    {{- if eq .Values.service.endpoints.restapi.tls.enforced "required" }}
    # Only tls when global tls is enabled and local tls is "required"
    - name: api-https
      port: {{ include "eric-fh-alarm-handler.restapi.server.tls.port" . }}
      targetPort: https-rest-api
    {{- else if eq .Values.service.endpoints.restapi.tls.enforced "optional" }}
    # Both tls and cleartext when global tls is enabled and local tls is "optional"
    - name: api-http
      port: {{ include "eric-fh-alarm-handler.restapi.server.port" . }}
      targetPort: http-rest-api
    - name: api-https
      port: {{ include "eric-fh-alarm-handler.restapi.server.tls.port" . }}
      targetPort: https-rest-api
    {{- end }}
  {{- end }}
  selector:
    app: {{ template "eric-fh-alarm-handler.name" . }}
    release: {{ .Release.Name }}
