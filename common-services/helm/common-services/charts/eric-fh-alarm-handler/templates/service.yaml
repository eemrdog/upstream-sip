{{- $g := fromJson (include "eric-fh-alarm-handler.global" .) }}
{{- $tls := (include "eric-fh-alarm-handler.tls.enabled" .) -}}
{{- $metricsEnabled := ( .Values.service.endpoints.metrics.enabled | toString | lower) -}}
{{- $metricsTLSOnly := (include "eric-fh-alarm-handler.metrics.server.tlsOnly" .) -}}
apiVersion: v1
kind: Service
metadata:
  name: {{ template "eric-fh-alarm-handler.name" . }}
  annotations:
{{- $service := include "eric-fh-alarm-handler.annotations" . | fromYaml -}}
{{- $metricsAnnotations := include "eric-fh-alarm-handler.metrics.annotations" . | fromYaml -}}
{{- include "eric-fh-alarm-handler.mergeAnnotations" (dict "location" .Template.Name "sources" (list $service $metricsAnnotations)) | indent 4}}
  labels:
{{- include "eric-fh-alarm-handler.labels" . | indent 4 }}
spec:
  {{- if $g.internalIPFamily }}
  ipFamilies: [{{ $g.internalIPFamily | quote }}]
  {{- end }}
  type: ClusterIP
  ports:
  {{/* DR-D1123-113 */}}
{{- if eq (include "eric-fh-alarm-handler.aalAPI.httpEnabled" .) "true" }}
    - name: api-http
      port: {{ include "eric-fh-alarm-handler.restapi.server.port" . }}
      targetPort: http-rest-api
{{- end }}
{{- if eq (include "eric-fh-alarm-handler.fiAPI.httpEnabled" .) "true" }}
    - name: fi-api-http
      port: {{ include "eric-fh-alarm-handler.rest.fi.server.httpPort" . }}
      targetPort: http-fi-api
{{- end }}
{{- if eq (include "eric-fh-alarm-handler.aalAPI.httpsEnabled" .) "true" }}
    - name: api-https
      port: {{ include "eric-fh-alarm-handler.restapi.server.tls.port" . }}
      targetPort: https-rest-api
{{- end }}
{{- if eq (include "eric-fh-alarm-handler.fiAPI.httpsEnabled" .) "true" }}
    - name: fi-api-https
      port: {{ include "eric-fh-alarm-handler.rest.fi.server.httpsPort" . }}
      targetPort: https-fi-api
{{- end }}
{{- if eq $metricsEnabled "true" }}
    - name: {{ include "eric-fh-alarm-handler.metrics.portName" . }}
      port: {{ include "eric-fh-alarm-handler.metrics.port" . }}
      targetPort: {{ include "eric-fh-alarm-handler.metrics.portName" . }}
{{- end }}
  selector:
    app: {{ template "eric-fh-alarm-handler.name" . }}
    release: {{ .Release.Name }}
