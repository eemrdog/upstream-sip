{{- if eq (include "eric-fh-alarm-handler.networkpolicies.enabled" .) "true" -}}
{{- /* DR-D1125-054 */ -}}
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ template "eric-fh-alarm-handler.name" . }}-default-access
  labels: {{ include "eric-fh-alarm-handler.labels" . | indent 4 }}
  annotations: {{ include "eric-fh-alarm-handler.annotations" . | indent 4 }}
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: {{ template "eric-fh-alarm-handler.name" . }}
  policyTypes:
  - Ingress
  ingress:
    - from:
      - podSelector:
          matchLabels:
            {{ template "eric-fh-alarm-handler.name" . }}-access: "true"
      ports:
{{- if eq (include "eric-fh-alarm-handler.fiAPI.httpEnabled" .) "true" }}
      - port: http-fi-api
        protocol: TCP
{{- end }}
{{- if eq (include "eric-fh-alarm-handler.fiAPI.httpsEnabled" .) "true" }}
      - port: https-fi-api
        protocol: TCP
{{- end }}
{{- if eq (include "eric-fh-alarm-handler.aalAPI.httpEnabled" .) "true" }}
      - port: http-rest-api
        protocol: TCP
{{- end }}
{{- if eq (include "eric-fh-alarm-handler.aalAPI.httpsEnabled" .) "true" }}
      - port: https-rest-api
        protocol: TCP
{{- end }}
--- {{/* DR-D1125-052 */}}
{{- $authorizationProxy := fromJson (include "eric-fh-alarm-handler.authz-proxy-values" .) }}
{{- $metricsEnabled := ( .Values.service.endpoints.metrics.enabled | toString | lower) -}}
{{- if or (and (and $authorizationProxy.enabled .Values.ingress.enabled) ($authorizationProxy.metrics.enabled)) (eq $metricsEnabled "true") }}
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ template "eric-fh-alarm-handler.name" . }}-pm-access
  labels: {{ include "eric-fh-alarm-handler.labels" . | indent 4 }}
  annotations: {{ include "eric-fh-alarm-handler.annotations" . | indent 4 }}
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: {{ template "eric-fh-alarm-handler.name" . }}
  policyTypes:
  - Ingress
  ingress:
    - from:
      - podSelector:
          matchLabels:
            app.kubernetes.io/name: {{ .Values.pmServer.serviceName }}
      ports:
{{- if and (and $authorizationProxy.enabled .Values.ingress.enabled) ($authorizationProxy.metrics.enabled) }}
      - port: http-apo2
        protocol: TCP
{{- end }}
{{- if eq $metricsEnabled "true" }}
      - port: {{ include "eric-fh-alarm-handler.metrics.portName" . }}
        protocol: TCP
{{- end }}
{{- end }}
--- {{/* DR-D1125-052 */}}
{{- if and $authorizationProxy.enabled .Values.ingress.enabled }}
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ template "eric-fh-alarm-handler.name" . }}-iccr-access
  labels: {{ include "eric-fh-alarm-handler.labels" . | indent 4 }}
  annotations: {{ include "eric-fh-alarm-handler.annotations" . | indent 4 }}
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: {{ template "eric-fh-alarm-handler.name" . }}
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: {{ $authorizationProxy.adpIccrServiceName }}
    ports:
    - port: http-apo2
      protocol: TCP
{{- end }}
{{- end }}
