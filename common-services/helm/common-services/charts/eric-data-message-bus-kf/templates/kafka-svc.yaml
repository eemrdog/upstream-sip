apiVersion: v1
kind: Service
metadata:
  name: {{ template "eric-data-message-bus-kf.fullname" . }}
  labels:
    {{- include "eric-data-message-bus-kf.labels" . | nindent 4 }}
  annotations:
    {{- $prometheusAnnotations := dict -}}
    {{- $_ := set $prometheusAnnotations "prometheus.io/scrape" (.Values.metricsexporter.enabled | toString) -}}
    {{- $_ := set $prometheusAnnotations "prometheus.io/port" (.Values.metricsexporter.port | toString) -}}
    {{- if eq (include "eric-data-message-bus-kf.tls" .) "true" -}}
      {{- $_ := set $prometheusAnnotations "prometheus.io/scheme" "https" -}}
    {{- else -}}
      {{- $_ := set $prometheusAnnotations "prometheus.io/scheme" "http" -}}
    {{- end -}}

    {{- $defaultAnnotations := include "eric-data-message-bus-kf.annotations" . | fromYaml -}}
    {{- include "eric-data-message-bus-kf.mergeAnnotations" (dict "location" .Template.Name "sources" (list $defaultAnnotations $prometheusAnnotations)) | trim | nindent 4 }}
spec:
  # ipFamilies was introduced in K8s v1.20
  {{- if (include "eric-data-message-bus-kf.internalIPFamily.global" .) }}
  ipFamilies: [{{- include "eric-data-message-bus-kf.internalIPFamily.global" . | quote }}]
  {{- end }}
  publishNotReadyAddresses: true
  ports:
{{- if or (include "eric-data-message-bus-kf.plaintext.enabled" . ) (include "eric-data-message-bus-kf.sasl" . ) }}
  - port: {{ template "eric-data-message-bus-kf.plaintextPort" . }}
    name: tcp-binary-p
    protocol: TCP
{{- end }}
{{- if eq (include "eric-data-message-bus-kf.tls" .) "true" }}
  - port: {{ .Values.security.tls.messagebuskf.port }}
    name: tls-binary
    protocol: TCP
  - port: {{ .Values.metricsexporter.port }}
    name: client-tls
    protocol: TCP
{{- end }}
  clusterIP: None
  selector:
    {{- include "eric-data-message-bus-kf.selector-labels-k8s" . | trim | nindent 4 }}
