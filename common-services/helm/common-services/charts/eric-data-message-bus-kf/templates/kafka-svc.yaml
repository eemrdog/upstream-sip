apiVersion: v1
kind: Service
metadata:
  name: {{ template "eric-data-message-bus-kf.fullname" . }}
  labels:
{{- include "eric-data-message-bus-kf.labels" . | indent 4}}
  annotations:
{{- include "eric-data-message-bus-kf.productinfo" . | indent 4 }}
{{- include "eric-data-message-bus-kf.config-annotations" . | indent 4}}
    prometheus.io/scrape: "{{ .Values.metricsexporter.enabled }}"
    prometheus.io/port: "{{ .Values.metricsexporter.port }}"
{{- if eq (include "eric-data-message-bus-kf.tls" .) "true" }}
    prometheus.io/scheme: "https"
{{- else }}
    prometheus.io/scheme: "http"
{{- end }}
spec:
  # ipFamilies was introduced in K8s v1.20
  {{- if (include "eric-data-message-bus-kf.internalIPFamily.global" .) }}
  ipFamilies: [{{- include "eric-data-message-bus-kf.internalIPFamily.global" . | quote }}]
  {{- end }}
  publishNotReadyAddresses: true
  ports:
{{- if or (include "eric-data-message-bus-kf.plaintext.enabled" . ) (include "eric-data-message-bus-kf.sasl" . ) }}
  - port: {{ template "eric-data-message-bus-kf.plaintextPort" . }}
    name: tcp-binary-p
    protocol: TCP
{{- end }}
{{- if eq (include "eric-data-message-bus-kf.tls" .) "true" }}
  - port: {{ .Values.security.tls.messagebuskf.port }}
    name: tls-binary
    protocol: TCP
  - port: {{ .Values.metricsexporter.port }}
    name: client-tls
    protocol: TCP
{{- end }}
  clusterIP: None
  selector:
{{- include "eric-data-message-bus-kf.selectorLabels" . | indent 4}}
