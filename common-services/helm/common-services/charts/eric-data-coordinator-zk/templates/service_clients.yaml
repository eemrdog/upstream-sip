apiVersion: v1
kind: Service
metadata:
  name: {{ template "eric-data-coordinator-zk.fullname" . }}
  labels:
{{- include "eric-data-coordinator-zk.labels" . | indent 4 }}
  annotations:
{{- include "eric-data-coordinator-zk.productinfo" . | indent 4 }}
{{- include "eric-data-coordinator-zk.config-annotations" . | indent 4 }}
{{- if .Values.metrics.enabled }}
    prometheus.io/scrape: "true"
    {{- if contains "clearText" (include "eric-data-coordinator-zk.pm.connectors" . ) }}
    prometheus.io/port: {{ .Values.service.endpoints.datacoordinatorzk.metricsPort | quote }}
    prometheus.io/scheme: "http"
    {{- else }}
    prometheus.io/port: {{ .Values.service.endpoints.pm.tls.port | quote }}
    prometheus.io/scheme: "https"
    {{- end }}
{{- end }}
spec:
  # ipFamilies was introduced in K8s v1.20
{{- if (include "eric-data-coordinator-zk.internalIPFamily.global" .) }}
  ipFamilies: [{{- include "eric-data-coordinator-zk.internalIPFamily.global" . | quote }}]
{{- end }}
  ports:
{{- if or (and (eq (include "eric-data-coordinator-zk.tls" .) "true") ( eq .Values.service.endpoints.datacoordinatorzk.tls.enforced "optional" )) (not (eq (include "eric-data-coordinator-zk.tls" .) "true" ))  }}
  - port: {{ .Values.clientPort }}
    name: zab-client
    protocol: TCP
{{- end }}
  - port: {{ .Values.network.datacoordinatorzk.adminServer.port }}
    name: http-adminport
    protocol: TCP
{{- if (eq (include "eric-data-coordinator-zk.tls" .) "true") }}
  - port: {{ .Values.network.datacoordinatorzk.client.tlsPort }}
    name: zab-tls-client
    protocol: TCP
{{- end }}
{{- if contains "clearText" (include "eric-data-coordinator-zk.pm.connectors" .) }}
  - port: {{ .Values.service.endpoints.datacoordinatorzk.metricsPort  }}
    name: http-metrics
    protocol: TCP
{{- else if contains "TLS" (include "eric-data-coordinator-zk.pm.connectors" .) }}
  - port: {{ .Values.service.endpoints.pm.tls.port  }}
    name: https-pm-tls
    protocol: TCP
{{- end }}
  selector:
{{- include "eric-data-coordinator-zk.selectorLabels" . | indent 4 }}
