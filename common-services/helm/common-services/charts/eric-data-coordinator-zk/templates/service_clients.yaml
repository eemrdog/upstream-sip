apiVersion: v1
kind: Service
metadata:
  name: {{ template "eric-data-coordinator-zk.fullname" . }}
  labels: {{- include "eric-data-coordinator-zk.labels" . | nindent 4 }}
  annotations:
    {{- $base := dict -}}
    {{- if .Values.metrics.enabled }}
      {{- $_ := set $base "prometheus.io/scrape" "true" -}}
      {{- if contains "clearText" (include "eric-data-coordinator-zk.pm.connectors" . ) }}
        {{- $_ := set $base "prometheus.io/port" (.Values.service.endpoints.datacoordinatorzk.metricsPort | toString) -}}
        {{- $_ := set $base "prometheus.io/scheme" "http" -}}
      {{- else }}
        {{- $_ := set $base "prometheus.io/port" (.Values.service.endpoints.pm.tls.port | toString) -}}
        {{- $_ := set $base "prometheus.io/scheme" "https" -}}
      {{- end }}
    {{- end }}
    {{- $default := include "eric-data-coordinator-zk.annotations" . | fromYaml -}}
    {{- include "eric-data-coordinator-zk.mergeAnnotations" (dict "location" (.Template.Name) "sources" (list $base $default)) | trim | nindent 4 }}
spec:
  # ipFamilies was introduced in K8s v1.20
{{- if (include "eric-data-coordinator-zk.internalIPFamily.global" .) }}
  ipFamilies: [{{- include "eric-data-coordinator-zk.internalIPFamily.global" . | quote }}]
{{- end }}
  ports:
{{- if or (and (eq (include "eric-data-coordinator-zk.tls" .) "true") ( eq .Values.service.endpoints.datacoordinatorzk.tls.enforced "optional" )) (not (eq (include "eric-data-coordinator-zk.tls" .) "true" ))  }}
  - port: {{ .Values.clientPort }}
    name: zab-client
    protocol: TCP
{{- end }}
  - port: {{ .Values.network.datacoordinatorzk.adminServer.port }}
    name: http-adminport
    protocol: TCP
{{- if (eq (include "eric-data-coordinator-zk.tls" .) "true") }}
  - port: {{ .Values.network.datacoordinatorzk.client.tlsPort }}
    name: zab-tls-client
    protocol: TCP
{{- end }}
{{- if contains "clearText" (include "eric-data-coordinator-zk.pm.connectors" .) }}
  - port: {{ .Values.service.endpoints.datacoordinatorzk.metricsPort  }}
    name: http-metrics
    protocol: TCP
{{- else if contains "TLS" (include "eric-data-coordinator-zk.pm.connectors" .) }}
  - port: {{ .Values.service.endpoints.pm.tls.port  }}
    name: https-pm-tls
    protocol: TCP
{{- end }}
  selector:
{{- include "eric-data-coordinator-zk.selectorLabels" . | indent 4 }}