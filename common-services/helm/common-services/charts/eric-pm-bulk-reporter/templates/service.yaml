{{- if not .Values.objectStorage.enabled }}
{{ if or ( eq (include "eric-pm-bulk-reporter-service.enabled-IPv4" .) "true" ) (eq (include "eric-pm-bulk-reporter-service.enabled-IPv6" .) "true" ) }}
{{- if eq (include "eric-pm-bulk-reporter-service.enabled-IPv4" .) "true" -}}
apiVersion: v1
kind: Service
metadata:
  name: eric-pm-bulk-reporter-service-ipv4
  labels: {{- include "eric-pm-bulk-reporter.labels" . | nindent 4 }}
  annotations: {{- include "eric-pm-bulk-reporter.annotations" . | nindent 2 }}
    prometheus.io/scrape: "false"
    {{- range $key, $value := .Values.service.externalIPv4.annotations }}
      {{- if and (eq $key "sharedVIPLabel") (not (empty $value)) }}
    metallb.universe.tf/allow-shared-ip: {{ $value | quote }}
      {{- else if and (eq $key "addressPoolName") (not (empty $value)) }}
    metallb.universe.tf/address-pool: {{ $value | quote }}
      {{- else if not (empty $value) }}
    {{ $key }}: {{ $value | quote }}
      {{- end }}
    {{ end }}
spec:
  ipFamilies: ["IPv4"] # ipFamilies was introduced in K8s v1.20
  type: LoadBalancer
{{- if .Values.service.externalIPv4.loadBalancerIP }}
  loadBalancerIP: {{ .Values.service.externalIPv4.loadBalancerIP }}
{{- end }}
  externalTrafficPolicy: {{ .Values.service.externalIPv4.externalTrafficPolicy }}
  ports:
    - port: {{ .Values.service.externalIPv4.servicePort }}
      targetPort: 2222
      protocol: TCP
      name: sftp
  selector:
    app: {{ template "eric-pm-bulk-reporter.name" . }}
    release: {{ .Release.Name }}
{{- end }}
---
{{ if eq (include "eric-pm-bulk-reporter-service.enabled-IPv6" .) "true" -}}
apiVersion: v1
kind: Service
metadata:
  name: eric-pm-bulk-reporter-service-ipv6
  labels: {{- include "eric-pm-bulk-reporter.labels" . | nindent 4 }}
  annotations: {{- include "eric-pm-bulk-reporter.annotations" . | nindent 2 }}
    prometheus.io/scrape: "false"
    {{- range $key, $value := .Values.service.externalIPv6.annotations }}
      {{- if and (eq $key "sharedVIPLabel") (not (empty $value)) }}
    metallb.universe.tf/allow-shared-ip: {{ $value | quote }}
      {{- else if and (eq $key "addressPoolName") (not (empty $value)) }}
    metallb.universe.tf/address-pool: {{ $value | quote }}
      {{- else if not (empty $value) }}
    {{ $key }}: {{ $value | quote }}
      {{- end }}
    {{ end }}
spec:
  ipFamilies: ["IPv6"] # ipFamilies was introduced in K8s v1.20
  type: LoadBalancer
{{- if .Values.service.externalIPv6.loadBalancerIP }}
  loadBalancerIP: {{ .Values.service.externalIPv6.loadBalancerIP }}
{{- end }}
  externalTrafficPolicy: {{ .Values.service.externalIPv6.externalTrafficPolicy }}
  ports:
    - port: {{ .Values.service.externalIPv6.servicePort }}
      targetPort: 2222
      protocol: TCP
      name: sftp
  selector:
    app: {{ template "eric-pm-bulk-reporter.name" . }}
    release: {{ .Release.Name }}
{{- end }}
{{ else }}
apiVersion: v1
kind: Service
metadata:
  name: {{ template "eric-pm-bulk-reporter.name" . }}
  labels: {{- include "eric-pm-bulk-reporter.labels" . | nindent 4 }}
  annotations: {{- include "eric-pm-bulk-reporter.annotations" . | nindent 2 }}
    {{- range $key, $value := .Values.service.annotations }}
      {{- if and (eq $key "sharedVIPLabel") (not (empty $value)) }}
    metallb.universe.tf/allow-shared-ip: {{ $value | quote }}
      {{- else if and (eq $key "addressPoolName") (not (empty $value)) }}
    metallb.universe.tf/address-pool: {{ $value | quote }}
      {{- else if not (empty $value) }}
    {{ $key }}: {{ $value | quote }}
      {{- end }}
    {{ end }}
    prometheus.io/scrape: "false"
spec:
  type: {{ .Values.service.type }}
{{- if .Values.service.loadBalancerIP }}
  loadBalancerIP: {{ .Values.service.loadBalancerIP | quote }}
{{- end }}
{{- if or (eq .Values.service.type "LoadBalancer") (eq .Values.service.type "NodePort") }}
  externalTrafficPolicy: {{ .Values.service.externalTrafficPolicy }}
{{- end }}
  ports:
    - port: {{ .Values.service.servicePort }}
      targetPort: 2222
      protocol: TCP
      name: sftp
  selector:
    app: {{ template "eric-pm-bulk-reporter.name" . }}
    release: {{ .Release.Name }}
{{- end }}
{{- end }}
